"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[3728],{1407:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>u,contentTitle:()=>p,default:()=>k,frontMatter:()=>o,metadata:()=>d,toc:()=>c});var a=n(7462),s=(n(7294),n(3905)),i=n(3612),r=n(4866),l=n(5162);const o={slug:"/docs/upsert-entities",beta:!0,notebook:"08_upsert_entities.ipynb",sidebar_position:2},p="Upsert Entity",d={unversionedId:"tutorials/collection/insert-update-and-delete/upsert-entities",id:"tutorials/collection/insert-update-and-delete/upsert-entities",title:"Upsert Entity",description:"\u672c\u6307\u5357\u4ecb\u7ecd\u5982\u4f55\u5728 Zilliz Cloud \u4e2d\u8fdb\u884c Upsert \u64cd\u4f5c\u3002",source:"@site/docs/tutorials/collection/insert-update-and-delete/upsert-entities.md",sourceDirName:"tutorials/collection/insert-update-and-delete",slug:"/docs/upsert-entities",permalink:"/docs/upsert-entities",draft:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{slug:"/docs/upsert-entities",beta:!0,notebook:"08_upsert_entities.ipynb",sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"\u63d2\u5165 Entity",permalink:"/docs/insert-entities"},next:{title:"\u5220\u9664 Entity",permalink:"/docs/delete-entities"}},u={},c=[{value:"\u5f00\u59cb\u524d",id:"before-you-start",level:2},{value:"\u51c6\u5907\u6570\u636e",id:"prepare-data",level:2},{value:"Upsert \u6570\u636e",id:"upsert-data",level:2},{value:"\u5199\u5165\u6570\u636e",id:"understand-flushing-data",level:2},{value:"\u4f7f\u7528\u9650\u5236",id:"limits",level:2},{value:"\u76f8\u5173\u6587\u6863",id:"related-topics",level:2}],m={toc:c},g="wrapper";function k(t){let{components:e,...n}=t;return(0,s.kt)(g,(0,a.Z)({},m,n,{components:e,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"upsert-entity"},"Upsert Entity"),(0,s.kt)("p",null,"\u672c\u6307\u5357\u4ecb\u7ecd\u5982\u4f55\u5728 Zilliz Cloud \u4e2d\u8fdb\u884c Upsert \u64cd\u4f5c\u3002"),(0,s.kt)("p",null,"\u6240\u8c13 Upsert\uff0c\u662f\u6307\u7ed3\u5408\u4e86 Update \u548c Insert \u4e24\u79cd\u64cd\u4f5c\u3002\u5728 Zilliz Cloud \u4e2d\uff0cUpsert \u64cd\u4f5c\u4f9d\u636e Entity \u7684\u4e3b\u952e\u662f\u5426\u5df2\u5728 Collection \u4e2d\u5b58\u5728\uff0c\u6765\u51b3\u5b9a\u662f\u63d2\u5165\u65b0\u7684 Entity \u8fd8\u662f\u66f4\u65b0\u73b0\u6709\u7684 Entity\u3002\u5177\u4f53\u89c4\u5219\u5982\u4e0b\uff1a"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"\u82e5 Entity \u7684\u4e3b\u952e\u5df2\u5728 Collection \u4e2d\uff0c\u539f\u6709\u7684 Entity \u4f1a\u88ab\u65b0\u6570\u636e\u8986\u76d6\u3002")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"\u82e5\u4e3b\u952e\u5728 Collection \u4e2d\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u6dfb\u52a0\u4e00\u4e2a\u5168\u65b0\u7684 Entity\u3002"))),(0,s.kt)(i.Z,{type:"info",icon:"\ud83d\udcd8",title:"\u8bf4\u660e",mdxType:"Admonition"},(0,s.kt)("p",null,"\u76ee\u524d\uff0cUpsert \u529f\u80fd\u5904\u4e8e Beta \u6d4b\u8bd5\u9636\u6bb5\u3002\u8bf7\u6ce8\u610f\uff0c\u8be5\u529f\u80fd\u53ca\u76f8\u5173\u6587\u6863\u5728 Beta \u6d4b\u8bd5\u671f\u95f4\u53ef\u80fd\u4f1a\u6709\u6240\u66f4\u6539\u3002")),(0,s.kt)("h2",{id:"before-you-start"},"\u5f00\u59cb\u524d"),(0,s.kt)("p",null,"\u5728\u6267\u884c Upsert \u64cd\u4f5c\u524d\uff0c\u8bf7\u786e\u4fdd\u4ee5\u4e0b\u51e0\u70b9\uff1a"),(0,s.kt)("p",null,"[Unsupported block type]"),(0,s.kt)("p",null,"[Unsupported block type]"),(0,s.kt)("h2",{id:"prepare-data"},"\u51c6\u5907\u6570\u636e"),(0,s.kt)("p",null,"\u672c\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u5c06\u5bf9\u793a\u4f8b\u6570\u636e\u96c6\u4e2d\u7684 Entity \u8fdb\u884c Upsert \u64cd\u4f5c\u3002\u60a8\u53ef\u4ee5\u7528\u4ee5\u4e0b\u4ee3\u7801\u6765\u5904\u7406\u6570\u636e\uff1a"),(0,s.kt)(r.Z,{groupId:"code",defaultValue:"python",values:[{label:"Python",value:"python"},{label:"NodeJS",value:"javascript"},{label:"Java",value:"java"},{label:"Bash",value:"bash"}],mdxType:"Tabs"},(0,s.kt)(l.Z,{value:"python",mdxType:"TabItem"},(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-python"},'# (Continued)\n\nimport json\n\nDATASET_PATH="../medium_articles_2020_dpr.json" # Set your dataset path\n\nwith open(\'medium_articles_2020_dpr.json\') as f:\n    data = json.load(f)\n    data_to_upsert = data["rows"][:100]\n\nprint(rows[0])\n\n# Prepare a list of rows\nwith open(DATASET_PATH) as f:\n    data = json.load(f)\n    rows = data[\'rows\']\n\nprint(rows[:3])\n\n# Output\n#\n# [\n#     {\n#         "id": 0,\n#         "title": "The Reported Mortality Rate of Coronavirus Is Not Important",\n#         "title_vector": [\n#             0.041732933,\n#             0.013779674,\n#             -0.027564144,\n#             -0.013061441,\n#             0.009748648,\n#             0.00082446384,\n#             -0.00071647146,\n#             0.048612226,\n#             -0.04836573,\n#             -0.04567751,\n#             "(758 more items hidden)"\n#         ],\n#         "link": "https://medium.com/swlh/the-reported-mortality-rate-of-coronavirus-is-not-important-369989c8d912",\n#         "reading_time": 13,\n#         "publication": "The Startup",\n#         "claps": 1100,\n#         "responses": 18\n#     }\n# ]\n'))),(0,s.kt)(l.Z,{value:"javascript",mdxType:"TabItem"},(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},"const fs = require('fs');\nconst data_file = `./medium_articles_2020_dpr.json`\n\nasync function main () {\n\n    // (Continued)\n    \n    const data = JSON.parse(fs.readFileSync(data_file, \"utf8\"))\n\n    // read rows\n    const rows = data[\"rows\"]\n    const row = rows[0]\n\n    console.log(Object.keys(row))\n\n    // Output\n    // \n    // [\n    //   'id',\n    //   'title',\n    //   'title_vector',\n    //   'link',\n    //   'reading_time',\n    //   'publication',\n    //   'claps',\n    //   'responses'\n    // ]\n    //     \n\n}\n"))),(0,s.kt)(l.Z,{value:"java",mdxType:"TabItem"},(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-java"},'public final class UseCustomizedSchemaDemo  {\n    public static void main(String[] args) {\n        \n        // (Continued)\n        \n        String data_file = "../medium_articles_2020_dpr.json";\n        \n        String content;\n\n        // read a local file\n        Path file = Path.of(data_file);\n        try {\n            content = Files.readString(file);\n        } catch (Exception e) {\n            System.err.println("Failed to read file: " + e.getMessage());\n            return;\n        }\n\n        System.out.println("Successfully read file");\n\n        // Output:\n        // Successfully read file\n        \n        // Load dataset\n        JSONObject dataset = JSON.parseObject(content);\n        List<JSONObject> rows = getRows(dataset.getJSONArray("rows"), 5979);\n        \n        // Also, you can get fields from dataset and insert them\n        // List<Field> fields = getFields(dataset.getJSONArray("rows"), 5979);\n    }\n    \n    public static List<JSONObject> getRows(JSONArray dataset, int counts) {\n        List<JSONObject> rows = new ArrayList<JSONObject>();\n        for (int i = 0; i < counts; i++) {\n            JSONObject row = dataset.getJSONObject(i);\n            List<Float> vectors = row.getJSONArray("title_vector").toJavaList(Float.class);\n            Long reading_time = row.getLong("reading_time");\n            Long claps = row.getLong("claps");\n            Long responses = row.getLong("responses");\n            row.put("title_vector", vectors);\n            row.put("reading_time", reading_time);\n            row.put("claps", claps);\n            row.put("responses", responses);\n            row.remove("id");\n            rows.add(row);\n        }\n        return rows;\n    }\n\n    public static List<Field> getFields(JSONArray dataset, int counts) {\n        List<Field> fields = new ArrayList<Field>();\n        List<String> titles = new ArrayList<String>();\n        List<List<Float>> title_vectors = new ArrayList<List<Float>>();\n        List<String> links = new ArrayList<String>();\n        List<Long> reading_times = new ArrayList<Long>();\n        List<String> publications = new ArrayList<String>();\n        List<Long> claps_list = new ArrayList<Long>();\n        List<Long> responses_list = new ArrayList<Long>();\n\n        for (int i = 0; i < counts; i++) {\n            JSONObject row = dataset.getJSONObject(i);\n            titles.add(row.getString("title"));\n            title_vectors.add(row.getJSONArray("title_vector").toJavaList(Float.class));\n            links.add(row.getString("link"));\n            reading_times.add(row.getLong("reading_time"));\n            publications.add(row.getString("publication"));\n            claps_list.add(row.getLong("claps"));\n            responses_list.add(row.getLong("responses"));\n        }\n\n        fields.add(new Field("title", titles));\n        fields.add(new Field("title_vector", title_vectors));\n        fields.add(new Field("link", links));\n        fields.add(new Field("reading_time", reading_times));\n        fields.add(new Field("publication", publications));\n        fields.add(new Field("claps", claps_list));\n        fields.add(new Field("responses", responses_list));\n\n        return fields;        \n    }\n}\n'))),(0,s.kt)(l.Z,{value:"bash",mdxType:"TabItem"},(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"# read the first 100 records from the dataset\ndata=\"$(cat path/to/medium_articles_2020_dpr.json \\\n        | jq '.rows' \\\n        | jq '.[1:100]' \\\n        | jq -r '.[] | . + {\"vector\": .title_vector} | del(.title_vector) | del(.id)' \\\n        | jq -s -c '.')\"\n        \n \n")))),(0,s.kt)("h2",{id:"upsert-data"},"Upsert \u6570\u636e"),(0,s.kt)("p",null,"\u6570\u636e\u51c6\u5907\u5b8c\u6bd5\u540e\uff0c\u53ef\u4f7f\u7528\u4ee5\u4e0b\u4ee3\u7801\u5c06\u5176 Upsert \u81f3 Collection\uff1a"),(0,s.kt)(r.Z,{groupId:"code",defaultValue:"python",values:[{label:"Python",value:"python"},{label:"NodeJS",value:"javascript"},{label:"Java",value:"java"},{label:"Bash",value:"bash"}],mdxType:"Tabs"},(0,s.kt)(l.Z,{value:"python",mdxType:"TabItem"},(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-python"},'# upsert entities\n# MilvusClient does not support upsert yet.\nfrom pymilvus import Collection\n# upsert data\nresult = collection.upsert(data_to_upsert)\n\n# flush data into memory\ncollection.flush()\n\nprint(f"Data upserted successfully! Upserted rows: {result.upsert_count}")\n\n# Output:\n# Data upserted successfully! Upserted rows: 100\n'))),(0,s.kt)(l.Z,{value:"javascript",mdxType:"TabItem"},(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},"async function main () {\n\n    // (Continued)\n    \n    //insert vectors\n    res = await client.upsert({\n        collection_name: collectionName,\n        data: rows.slice(1, 1000)\n    })\n\n    console.log(res)\n\n    // Output\n    // \n    // {\n    //   succ_index: [\n    //      0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11,\n    //     12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,\n    //     24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35,\n    //     36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47,\n    //     48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59,\n    //     60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71,\n    //     72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83,\n    //     84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95,\n    //     96, 97, 98, 99,\n    //     ... 899 more items\n    //   ],\n    //   err_index: [],\n    //   status: { error_code: 'Success', reason: '', code: 0 },\n    //   IDs: { int_id: { data: [Array] }, id_field: 'int_id' },\n    //   acknowledged: false,\n    //   insert_cnt: '999',\n    //   delete_cnt: '999',\n    //   upsert_cnt: '999',\n    //   timestamp: '445315186586025986'\n    // }\n    // \n\n}\n"))),(0,s.kt)(l.Z,{value:"java",mdxType:"TabItem"},(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-java"},'import io.milvus.param.*;\nimport io.milvus.response.MutationResultWrapper;\nimport io.milvus.grpc.MutationResult;\n\npublic class UseCustomizedSchemaDemo \n{\n    public static void main( String[] args )\n    {\n        // (Continued)\n        \n        UpsertParam upsertParam = UpsertParam.newBuilder()\n            .withCollectionName(collectionName)\n            .withRows(rows)\n            // .withFields(fields)\n            .build();\n\n        R<MutationResult> upsertResponse = client.upsert(upsertParam);\n\n        if (upsertResponse.getStatus() != R.Status.Success.getCode()) {\n            System.err.println(upsertResponse.getMessage());\n        }\n\n        MutationResultWrapper mutationResultWrapper = new MutationResultWrapper(upsertResponse.getData());\n\n        System.out.println("Successfully insert entities: " + mutationResultWrapper.getInsertCount());  \n\n        // Output:\n        // Successfully insert entities: 100\n    }\n}\n'))),(0,s.kt)(l.Z,{value:"bash",mdxType:"TabItem"},(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'# insert record \ncurl --request POST \\\n     --url "${PUBLIC_ENDPOINT}/v1/vector/upsert" \\\n     --header "Authorization: Bearer ${TOKEN}" \\\n     --header \'accept: application/json\' \\\n     --header \'content-type: application/json\' \\\n     --data "{\n        \\"collectionName\\": \\"medium_articles_2020\\",\n        \\"data\\": ${data}\n    }"\n\n# Response\n#\n# {\n#     "code": 200,\n#     "data": {\n#         "upsertCount": 99,\n#         "upsertIds": [\n#             "442169042773493965",\n#             "442169042773493966"\uff0c\n#             ...\n#         ]\n#     }\n# }\n')))),(0,s.kt)("h2",{id:"understand-flushing-data"},"\u5199\u5165\u6570\u636e"),(0,s.kt)("p",null,"Zilliz Cloud \u4f1a\u81ea\u52a8\u5b58\u50a8\u5df2\u63d2\u5165\u7684\u6570\u636e\u3002"),(0,s.kt)("p",null,"\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6bcf\u6b21\u6570\u636e\u63d2\u5165\u65e0\u9700\u523b\u610f\u8c03\u7528 ",(0,s.kt)("inlineCode",{parentName:"p"},"flush()")," API\u3002\u4f46\u5982\u679c\u60a8\u9700\u8981\u7acb\u5373\u5bf9\u65b0\u63d2\u5165\u7684\u6570\u636e\u8fdb\u884c\u641c\u7d22\uff0c\u53ef\u4ee5\u8003\u8651\u6267\u884c ",(0,s.kt)("inlineCode",{parentName:"p"},"flush()")," \u64cd\u4f5c\u3002"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"flush()")," \u4e3b\u8981\u7528\u4e8e\u6574\u7406\u548c\u5904\u7406\u6570\u636e\u7247\u6bb5\uff0c\u786e\u4fdd\u60a8\u6700\u65b0\u6dfb\u52a0\u7684 Entity \u80fd\u591f\u7acb\u5373\u88ab\u68c0\u7d22\u5230\u3002\u5982\u679c\u6ca1\u6709\u8fd9\u4e00\u6b65\u9aa4\uff0c\u7531\u4e8e\u65b0\u6570\u636e\u8fd8\u672a\u53ca\u65f6\u88ab\u7d22\u5f15\uff0c\u5b83\u4eec\u53ef\u80fd\u6682\u65f6\u4e0d\u4f1a\u51fa\u73b0\u5728\u68c0\u7d22\u7ed3\u679c\u4e2d\u3002"),(0,s.kt)("p",null,"\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u60a8\u65e0\u9700\u624b\u52a8\u8c03\u7528 ",(0,s.kt)("inlineCode",{parentName:"p"},"flush()"),"\u3002\u7cfb\u7edf\u4f1a\u81ea\u52a8\u4f18\u96c5\u5730\u5904\u7406\u8fd9\u4e00\u8fc7\u7a0b\u3002"),(0,s.kt)("h2",{id:"limits"},"\u4f7f\u7528\u9650\u5236"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"Upsert \u64cd\u4f5c\u4e0d\u4f1a\u66f4\u65b0\u4e3b\u952e\u503c\u3002")),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},"Upsert \u64cd\u4f5c\u4e0d\u652f\u6301\u5f00\u542f\u4e86 ",(0,s.kt)("inlineCode",{parentName:"p"},"autoID")," \u7684 Collection\u3002"))),(0,s.kt)("h2",{id:"related-topics"},"\u76f8\u5173\u6587\u6863"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("a",{parentName:"p",href:"./create-collection"},"\u521b\u5efa Collection"))),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("a",{parentName:"p",href:"./enable-dynamic-schema"},"\u5f00\u542f\u52a8\u6001 Schema"))),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("a",{parentName:"p",href:"./use-partition-key"},"\u4f7f\u7528 Partition Key")))))}k.isMDXComponent=!0}}]);